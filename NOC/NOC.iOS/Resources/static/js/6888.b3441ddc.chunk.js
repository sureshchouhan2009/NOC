"use strict";(self.webpackChunketihadrailapp=self.webpackChunketihadrailapp||[]).push([[6888],{38330:function(e,t,n){n.d(t,{t:function(){return s}});var r=n(1413),a=n(15861),i=n(87757),o=n(76200);function s(e,t){return l.apply(this,arguments)}function l(){return l=(0,a.Z)(i.mark((function e(t,n){var a,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,o.default)(t,(0,r.Z)({responseType:"image"},n));case 2:return a=e.sent,s=a.data,e.abrupt("return",s);case 5:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}},22357:function(e,t,n){n.d(t,{q:function(){return l}});var r,a,i,o=n(30168),s=n(98634);function l(e,t){0===t.output&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add((0,s.H)(r||(r=(0,o.Z)(["void forwardLinearDepth() { linearDepth = gl_Position.w; }"]))))):1===t.output||3===t.output?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("cameraNearFar","vec2"),e.vertex.code.add((0,s.H)(a||(a=(0,o.Z)(["void forwardLinearDepth() {\nlinearDepth = (-position_view().z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);\n}"]))))):e.vertex.code.add((0,s.H)(i||(i=(0,o.Z)(["void forwardLinearDepth() {}"]))))}},49223:function(e,t,n){n.d(t,{LC:function(){return v},Mo:function(){return f}});var r,a,i,o,s,l,u=n(30168),c=n(62993),d=n(98634);function v(e,t){var n=e.vertex.code;t.verticalOffsetEnabled?(e.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&(e.include(c.c),e.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4")),n.add((0,d.H)(r||(r=(0,u.Z)(["\n    vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {\n      float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);\n      ","\n      ","\n      // Screen sized offset in world space, used for example for line callouts\n      float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);\n      return worldNormal * worldOffset;\n    }\n\n    vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {\n      return worldPos + calculateVerticalOffset(worldPos, localOrigin);\n    }\n    "])),1===t.viewingMode?(0,d.H)(a||(a=(0,u.Z)(["vec3 worldNormal = normalize(worldPos + localOrigin);"]))):(0,d.H)(i||(i=(0,u.Z)(["vec3 worldNormal = vec3(0.0, 0.0, 1.0);"]))),t.screenSizePerspectiveEnabled?(0,d.H)(o||(o=(0,u.Z)(["\n          float cosAngle = dot(worldNormal, normalize(worldPos - camPos));\n          float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);"]))):(0,d.H)(s||(s=(0,u.Z)(["\n          float verticalOffsetScreenHeight = verticalOffset.x;"])))))):n.add((0,d.H)(l||(l=(0,u.Z)(["vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }"]))))}function f(e,t,n){if(t.verticalOffset){var r=p(t.verticalOffset,n.camera.fovY,n.camera.fullViewport[3]),a=n.camera.pixelRatio||1;e.setUniform4f("verticalOffset",r.screenLength*a,r.perDistance,r.minWorldLength,r.maxWorldLength)}}function p(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:h;return r.screenLength=e.screenLength,r.perDistance=Math.tan(.5*t)/(.5*n),r.minWorldLength=e.minWorldLength,r.maxWorldLength=e.maxWorldLength,r}var h={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}},2116:function(e,t,n){n.d(t,{T:function(){return T}});var r,a,i,o=n(30168),s=n(98634);function l(e){var t=e.fragment.code;t.add((0,s.H)(r||(r=(0,o.Z)(["vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)\n{\nreturn ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;\n}"])))),t.add((0,s.H)(a||(a=(0,o.Z)(["float integratedRadiance(float cosTheta2, float roughness)\n{\nreturn (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);\n}"])))),t.add((0,s.H)(i||(i=(0,o.Z)(["vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)\n{\nfloat cosTheta2 = 1.0 - RdotNG * RdotNG;\nfloat intRadTheta = integratedRadiance(cosTheta2, roughness);\nfloat ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;\nfloat sky = 2.0 - ground;\nreturn (ground * ambientGround + sky * ambientSky) * 0.5;\n}"]))))}var u,c,d,v,f,p,h,m,g,x,S,w=n(85586);function T(e,t){var n=e.fragment.code;e.include(w.e),3===t.pbrMode||4===t.pbrMode?(n.add((0,s.H)(u||(u=(0,o.Z)(["\n    struct PBRShadingWater\n    {\n        float NdotL;   // cos angle between normal and light direction\n        float NdotV;   // cos angle between normal and view direction\n        float NdotH;   // cos angle between normal and half vector\n        float VdotH;   // cos angle between view direction and half vector\n        float LdotH;   // cos angle between light direction and half vector\n        float VdotN;   // cos angle between view direction and normal vector\n    };\n\n    float dtrExponent = ",";\n    "])),t.useCustomDTRExponentForWater?"2.2":"2.0")),n.add((0,s.H)(c||(c=(0,o.Z)(["vec3 fresnelReflection(float angle, vec3 f0, float f90) {\nreturn f0 + (f90 - f0) * pow(1.0 - angle, 5.0);\n}"])))),n.add((0,s.H)(d||(d=(0,o.Z)(["float normalDistributionWater(float NdotH, float roughness)\n{\nfloat r2 = roughness * roughness;\nfloat NdotH2 = NdotH * NdotH;\nfloat denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;\nreturn r2 / denom;\n}"])))),n.add((0,s.H)(v||(v=(0,o.Z)(["float geometricOcclusionKelemen(float LoH)\n{\nreturn 0.25 / (LoH * LoH);\n}"])))),n.add((0,s.H)(f||(f=(0,o.Z)(["vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)\n{\nvec3  F = fresnelReflection(props.VdotH, F0, F0Max);\nfloat dSun = normalDistributionWater(props.NdotH, roughness);\nfloat V = geometricOcclusionKelemen(props.LdotH);\nfloat diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);\nfloat strengthSunHaze  = 1.2;\nfloat dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;\nreturn ((dSun + dSunHaze) * V) * F;\n}\nvec3 tonemapACES(const vec3 x) {\nreturn (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);\n}"]))))):1!==t.pbrMode&&2!==t.pbrMode||(e.include(l),n.add((0,s.H)(p||(p=(0,o.Z)(["struct PBRShadingInfo\n{\nfloat NdotL;\nfloat NdotV;\nfloat NdotH;\nfloat VdotH;\nfloat LdotH;\nfloat NdotNG;\nfloat RdotNG;\nfloat NdotAmbDir;\nfloat NdotH_Horizon;\nvec3 skyRadianceToSurface;\nvec3 groundRadianceToSurface;\nvec3 skyIrradianceToSurface;\nvec3 groundIrradianceToSurface;\nfloat averageAmbientRadiance;\nfloat ssao;\nvec3 albedoLinear;\nvec3 f0;\nvec3 f90;\nvec3 diffuseColor;\nfloat metalness;\nfloat roughness;\n};"])))),n.add((0,s.H)(h||(h=(0,o.Z)(["float normalDistribution(float NdotH, float roughness)\n{\nfloat a = NdotH * roughness;\nfloat b = roughness / (1.0 - NdotH * NdotH + a * a);\nreturn b * b * INV_PI;\n}"])))),n.add((0,s.H)(m||(m=(0,o.Z)(["const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);\nconst vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);\nconst vec2 c2 = vec2(-1.04, 1.04);\nvec2 prefilteredDFGAnalytical(float roughness, float NdotV) {\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;\nreturn c2 * a004 + r.zw;\n}"])))),n.add((0,s.H)(g||(g=(0,o.Z)(["vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {\nvec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);\nvec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);\nvec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;\nvec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);\nvec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;\nvec3 specularComponent = specularColor * indirectSpecular;\nreturn (diffuseComponent + specularComponent);\n}"])))),n.add((0,s.H)(x||(x=(0,o.Z)(["float gamutMapChanel(float x, vec2 p){\nreturn (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );\n}"])))),n.add((0,s.H)(S||(S=(0,o.Z)(["vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){\nvec3 outColor;\nvec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));\noutColor.x = gamutMapChanel(inColor.x, p) ;\noutColor.y = gamutMapChanel(inColor.y, p) ;\noutColor.z = gamutMapChanel(inColor.z, p) ;\nreturn outColor;\n}"])))))}},85586:function(e,t,n){n.d(t,{e:function(){return s}});var r,a,i=n(30168),o=n(98634);function s(e){e.vertex.code.add((0,o.H)(r||(r=(0,i.Z)(["const float PI = 3.141592653589793;"])))),e.fragment.code.add((0,o.H)(a||(a=(0,i.Z)(["const float PI = 3.141592653589793;\nconst float LIGHT_NORMALIZATION = 1.0 / PI;\nconst float INV_PI = 0.3183098861837907;\nconst float HALF_PI = 1.570796326794897;"]))))}},23235:function(e,t,n){n.d(t,{hX:function(){return s},O2:function(){return l},mi:function(){return c},vL:function(){return u}});var r,a=n(30168),i=n(78980),o=n(98634);function s(e){e.fragment.include(i.n),e.fragment.uniforms.add("uShadowMapTex","sampler2D"),e.fragment.uniforms.add("uShadowMapNum","int"),e.fragment.uniforms.add("uShadowMapDistance","vec4"),e.fragment.uniforms.add("uShadowMapMatrix","mat4",4),e.fragment.uniforms.add("uDepthHalfPixelSz","float"),e.fragment.code.add((0,o.H)(r||(r=(0,a.Z)(["int chooseCascade(float _linearDepth, out mat4 mat) {\nvec4 distance = uShadowMapDistance;\nfloat depth = _linearDepth;\nint i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;\nmat = i == 0 ? uShadowMapMatrix[0] : i == 1 ? uShadowMapMatrix[1] : i == 2 ? uShadowMapMatrix[2] : uShadowMapMatrix[3];\nreturn i;\n}\nvec3 lightSpacePosition(vec3 _vpos, mat4 mat) {\nvec4 lv = mat * vec4(_vpos, 1.0);\nlv.xy /= lv.w;\nreturn 0.5 * lv.xyz + vec3(0.5);\n}\nvec2 cascadeCoordinates(int i, vec3 lvpos) {\nreturn vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;\n}\nfloat readShadowMapDepth(vec2 uv, sampler2D _depthTex) {\nreturn rgba2float(texture2D(_depthTex, uv));\n}\nfloat posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {\nreturn readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;\n}\nfloat filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {\nfloat texSize = 0.5 / halfPixelSize;\nvec2 st = fract((vec2(halfPixelSize) + uv) * texSize);\nfloat s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);\nfloat s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);\nfloat s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);\nfloat s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);\nreturn mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);\n}\nfloat readShadowMap(const in vec3 _vpos, float _linearDepth) {\nmat4 mat;\nint i = chooseCascade(_linearDepth, mat);\nif (i >= uShadowMapNum) { return 0.0; }\nvec3 lvpos = lightSpacePosition(_vpos, mat);\nif (lvpos.z >= 1.0) { return 0.0; }\nif (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }\nvec2 uv = cascadeCoordinates(i, lvpos);\nreturn filterShadow(uv, lvpos, uDepthHalfPixelSz, uShadowMapTex);\n}"]))))}function l(e,t){t.shadowMappingEnabled&&(t.shadowMap.bind(e),t.shadowMap.bindView(e,t.origin))}function u(e,t,n){t.shadowMappingEnabled&&t.shadowMap.bindView(e,n)}function c(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}},18607:function(e,t,n){n.d(t,{kl:function(){return v},kz:function(){return f},uj:function(){return h},s0:function(){return p}});var r,a,i,o,s,l,u,c=n(30168),d=n(98634);function v(e,t){t.vvInstancingEnabled&&(t.vvSize||t.vvColor)&&e.attributes.add("instanceFeatureAttribute","vec4"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.uniforms.add("vvSymbolRotationMatrix","mat3"),e.vertex.uniforms.add("vvSymbolAnchor","vec3"),e.vertex.code.add((0,d.H)(r||(r=(0,c.Z)(["vec3 vvScale(vec4 _featureAttribute) {\nreturn clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);\n}\nvec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {\nreturn vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);\n}"])))),e.vertex.code.add((0,d.H)(a||(a=(0,c.Z)(["\n      const float eps = 1.192092896e-07;\n      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {\n        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);\n        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);\n      }\n\n      ","\n    "])),t.vvInstancingEnabled?(0,d.H)(i||(i=(0,c.Z)(["\n      vec4 vvLocalNormal(vec3 _normal) {\n        return vvTransformNormal(_normal, instanceFeatureAttribute);\n      }\n\n      vec4 localPosition() {\n        return vvTransformPosition(position, instanceFeatureAttribute);\n      }"]))):""))):e.vertex.code.add((0,d.H)(o||(o=(0,c.Z)(["vec4 localPosition() { return vec4(position, 1.0); }\nvec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }"])))),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add((0,d.H)(s||(s=(0,c.Z)(["\n      uniform float vvColorValues[vvColorNumber];\n      uniform vec4 vvColorColors[vvColorNumber];\n\n      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {\n        float value = featureAttribute.y;\n        if (value <= values[0]) {\n          return colors[0];\n        }\n\n        for (int i = 1; i < vvColorNumber; ++i) {\n          if (values[i] >= value) {\n            float f = (value - values[i-1]) / (values[i] - values[i-1]);\n            return mix(colors[i-1], colors[i], f);\n          }\n        }\n        return colors[vvColorNumber - 1];\n      }\n\n      ","\n    "])),t.vvInstancingEnabled?(0,d.H)(l||(l=(0,c.Z)(["\n      vec4 vvColor() {\n        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);\n      }"]))):""))):e.vertex.code.add((0,d.H)(u||(u=(0,c.Z)(["vec4 vvColor() { return vec4(1.0); }"]))))}function f(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors))}function p(e,t){f(e,t),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}function h(e,t){f(e,t),t.vvSizeEnabled&&(e.setUniform3fv("vvSymbolAnchor",t.vvSymbolAnchor),e.setUniformMatrix3fv("vvSymbolRotationMatrix",t.vvSymbolRotationMatrix))}},62993:function(e,t,n){n.d(t,{c:function(){return f},y:function(){return p}});var r,a,i,o,s,l,u,c=n(30168),d=n(98634),v=n(22909);function f(e){e.vertex.code.add((0,d.H)(r||(r=(0,c.Z)(["float screenSizePerspectiveMinSize(float size, vec4 factor) {\nfloat nonZeroSize = 1.0 - step(size, 0.0);\nreturn (\nfactor.z * (\n1.0 +\nnonZeroSize *\n2.0 * factor.w / (\nsize + (1.0 - nonZeroSize)\n)\n)\n);\n}"])))),e.vertex.code.add((0,d.H)(a||(a=(0,c.Z)(["float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {\nreturn absCosAngle * absCosAngle * absCosAngle;\n}"])))),e.vertex.code.add((0,d.H)(i||(i=(0,c.Z)(["vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {\nreturn vec4(\nmin(params.x / (distanceToCamera - params.y), 1.0),\nscreenSizePerspectiveViewAngleDependentFactor(absCosAngle),\nparams.z,\nparams.w\n);\n}"])))),e.vertex.code.add((0,d.H)(o||(o=(0,c.Z)(["float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {\nreturn max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));\n}"])))),e.vertex.code.add((0,d.H)(s||(s=(0,c.Z)(["float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {\nreturn applyScreenSizePerspectiveScaleFactorFloat(\nsize,\nscreenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)\n);\n}"])))),e.vertex.code.add((0,d.H)(l||(l=(0,c.Z)(["vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {\nreturn mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / size.y, 1.0), size, factor.y);\n}"])))),e.vertex.code.add((0,d.H)(u||(u=(0,c.Z)(["vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {\nreturn applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));\n}"]))))}function p(e,t){if(t.screenSizePerspective){(0,v.bj)(t.screenSizePerspective,e,"screenSizePerspective");var n=t.screenSizePerspectiveAlignment||t.screenSizePerspective;(0,v.bj)(n,e,"screenSizePerspectiveAlignment")}}},40485:function(e,t,n){n.d(t,{Z:function(){return l}});var r=n(15671),a=n(43144),i=n(60136),o=n(29388),s=n(92026),l=function(e){(0,i.Z)(n,e);var t=(0,o.Z)(n);function n(e){var a;return(0,r.Z)(this,n),(a=t.call(this,e))._numLoading=0,a._disposed=!1,a._textureRepository=e.textureRep,a._textureId=e.textureId,a._acquire(e.textureId).then((function(e){return a._texture=e})),a._acquire(e.normalTextureId).then((function(e){return a._textureNormal=e})),a._acquire(e.emissiveTextureId).then((function(e){return a._textureEmissive=e})),a._acquire(e.occlusionTextureId).then((function(e){return a._textureOcclusion=e})),a._acquire(e.metallicRoughnessTextureId).then((function(e){return a._textureMetallicRoughness=e})),a}return(0,a.Z)(n,[{key:"dispose",value:function(){this._texture=(0,s.RY)(this._texture),this._textureNormal=(0,s.RY)(this._textureNormal),this._textureEmissive=(0,s.RY)(this._textureEmissive),this._textureOcclusion=(0,s.RY)(this._textureOcclusion),this._textureMetallicRoughness=(0,s.RY)(this._textureMetallicRoughness),this._disposed=!0}},{key:"ensureResources",value:function(e){return 0===this._numLoading?2:1}},{key:"updateTexture",value:function(e){var t=this;((0,s.Wi)(this._texture)||e!==this._texture.id)&&(this._texture=(0,s.RY)(this._texture),this._textureId=e,this._acquire(this._textureId).then((function(e){return t._texture=e})))}},{key:"bindTextures",value:function(e){(0,s.pC)(this._texture)&&e.bindTexture(this._texture.glTexture,"tex"),(0,s.pC)(this._textureNormal)&&e.bindTexture(this._textureNormal.glTexture,"normalTexture"),(0,s.pC)(this._textureEmissive)&&e.bindTexture(this._textureEmissive.glTexture,"texEmission"),(0,s.pC)(this._textureOcclusion)&&e.bindTexture(this._textureOcclusion.glTexture,"texOcclusion"),(0,s.pC)(this._textureMetallicRoughness)&&e.bindTexture(this._textureMetallicRoughness.glTexture,"texMetallicRoughness")}},{key:"bindTextureScale",value:function(e){var t=(0,s.pC)(this._texture)?this._texture.glTexture:null;(0,s.pC)(t)&&t.descriptor.textureCoordinateScaleFactor?e.setUniform2fv("textureCoordinateScaleFactor",t.descriptor.textureCoordinateScaleFactor):e.setUniform2f("textureCoordinateScaleFactor",1,1)}},{key:"_acquire",value:function(e){var t=this;return(0,s.Wi)(e)?Promise.resolve(null):(++this._numLoading,this._textureRepository.acquire(e).then((function(e){return t._disposed?((0,s.RY)(e),null):e})).finally((function(){return--t._numLoading})))}}]),n}(n(23620).Z)},83602:function(e,t,n){n.d(t,{x:function(){return X}});var r,a=n(15861),i=n(15671),o=n(43144),s=n(60136),l=n(29388),u=n(87757),c=n(41644),d=n(10064),v=n(91505),f=n(16889),p=n(92026),h=n(66978),m=n(18722),g=n(35995),x=n(38330),S=n(5640),w=n(1413),T=n(29439),b=n(65905);function y(){if((0,p.Wi)(r)){var e=function(e){return(0,b.V)("esri/libs/basisu/".concat(e))};r=n.e(1562).then(n.bind(n,61562)).then((function(e){return e.b})).then((function(t){return(0,t.default)({locateFile:e}).then((function(e){return e.initializeBasis(),delete e.then,e}))}))}return r}var _=n(51378),z=n(3384),C=null,M=null;function H(){return P.apply(this,arguments)}function P(){return(P=(0,a.Z)(u.mark((function e(){return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=(0,p.Wi)(M),!e.t0){e.next=6;break}return M=y(),e.next=5,M;case 5:C=e.sent;case 6:return e.abrupt("return",M);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function I(e,t,n,r,a){var i=(0,z.RG)(t?37496:37492),o=a&&e>1?(Math.pow(4,e)-1)/(3*Math.pow(4,e-1)):1;return Math.ceil(n*r*i*o)}function F(e){return e.getNumImages()>=1&&!e.isUASTC()}function D(e){return e.getFaces()>=1&&e.isETC1S()}function N(){return N=(0,a.Z)(u.mark((function e(t,n,r){var a,i;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=(0,p.Wi)(C),!e.t0){e.next=5;break}return e.next=4,H();case 4:C=e.sent;case 5:if(F(a=new C.BasisFile(new Uint8Array(r)))){e.next=8;break}return e.abrupt("return",null);case 8:return a.startTranscoding(),i=O(t,n,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(function(e,t){return a.getImageTranscodedSizeInBytes(0,e,t)}),(function(e,t,n){return a.transcodeImage(n,0,e,t,0,0)})),e.abrupt("return",(a.close(),a.delete(),i));case 11:case"end":return e.stop()}}),e)}))),N.apply(this,arguments)}function A(){return A=(0,a.Z)(u.mark((function e(t,n,r){var a,i;return u.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=(0,p.Wi)(C),!e.t0){e.next=5;break}return e.next=4,H();case 4:C=e.sent;case 5:if(D(a=new C.KTX2File(new Uint8Array(r)))){e.next=8;break}return e.abrupt("return",null);case 8:return a.startTranscoding(),i=O(t,n,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(function(e,t){return a.getImageTranscodedSizeInBytes(e,0,0,t)}),(function(e,t,n){return a.transcodeImage(n,e,0,0,t,0,-1,-1)})),e.abrupt("return",(a.close(),a.delete(),i));case 11:case"end":return e.stop()}}),e)}))),A.apply(this,arguments)}function O(e,t,n,r,a,i,o,s){for(var l=e.capabilities,u=l.compressedTextureETC,c=l.compressedTextureS3TC,d=u?r?[1,37496]:[0,37492]:c?r?[3,33779]:[2,33776]:[13,6408],v=(0,T.Z)(d,2),f=v[0],p=v[1],h=t.hasMipmap?n:Math.min(1,n),m=[],g=0;g<h;g++)m.push(new Uint8Array(o(g,f))),s(g,f,m[g]);var x=m.length>1,S=x?9987:9729,b=(0,w.Z)((0,w.Z)({},t),{},{samplingMode:S,hasMipmap:x,internalFormat:p,width:a,height:i});return new _.Z(e,b,{type:"compressed",levels:m})}var Z=n(1395),k=n(32718).Z.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function R(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}var L=R("DXT1"),E=R("DXT3"),V=R("DXT5");function U(e,t){var n=new Int32Array(e,0,31);if(542327876!==n[0])return k.error("Invalid magic number in DDS header"),null;if(!(4&n[20]))return k.error("Unsupported format, must contain a FourCC code"),null;var r,a,i=n[21];switch(i){case L:r=8,a=33776;break;case E:r=16,a=33778;break;case V:r=16,a=33779;break;default:return k.error("Unsupported FourCC code:",function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}(i)),null}var o=1,s=n[4],l=n[3];0==(3&s)&&0==(3&l)||(k.warn("Rounding up compressed texture size to nearest multiple of 4."),s=s+3&-4,l=l+3&-4);var u,c,d=s,v=l;131072&n[2]&&!1!==t&&(o=Math.max(1,n[7])),1===o||(0,f.wt)(s)&&(0,f.wt)(l)||(k.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);for(var p=n[1]+4,h=[],m=0;m<o;++m)c=(s+3>>2)*(l+3>>2)*r,u=new Uint8Array(e,p,c),h.push(u),p+=c,s=Math.max(1,s>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:h},internalFormat:a,width:d,height:v}}var W=n(32534),G=n(97731),q=n(53634),B=n(30308),X=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,r){var a;return(0,i.Z)(this,n),(a=t.call(this)).data=e,a.type=4,a._glTexture=null,a._powerOfTwoStretchInfo=null,a._loadingPromise=null,a._loadingController=null,a.events=new v.Z,a.params=r||{},a.params.mipmap=!1!==a.params.mipmap,a.params.noUnpackFlip=a.params.noUnpackFlip||!1,a.params.preMultiplyAlpha=a.params.preMultiplyAlpha||!1,a.params.wrap=a.params.wrap||{s:10497,t:10497},a.params.powerOfTwoResizeMode=a.params.powerOfTwoResizeMode||1,a.estimatedTexMemRequired=n.estimateTexMemRequired(a.data,a.params),a.startPreload(),a}return(0,o.Z)(n,[{key:"startPreload",value:function(){var e=this.data;(0,p.Wi)(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))}},{key:"startPreloadVideoElement",value:function(e){(0,g.jc)(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)}},{key:"startPreloadImageElement",value:function(e){(0,g.HK)(e.src)||(0,g.jc)(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}},{key:"dispose",value:function(){this.data=void 0}},{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},{key:"createDescriptor",value:function(e){var t;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!=(t=this.params.maxAnisotropy)?t:this.params.mipmap?e.parameters.maxMaxAnisotropy:1}}},{key:"glTexture",get:function(){return this._glTexture}},{key:"load",value:function(e,t){if((0,p.pC)(this._glTexture))return this._glTexture;if((0,p.pC)(this._loadingPromise))return this._loadingPromise;var r=this.data;return(0,p.Wi)(r)?(this._glTexture=new _.Z(e,this.createDescriptor(e),null),this._glTexture):"string"==typeof r?this.loadFromURL(e,t,r):r instanceof Image?this.loadFromImageElement(e,t,r):r instanceof HTMLVideoElement?this.loadFromVideoElement(e,t,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this.loadFromImage(e,r,t):((0,m.eP)(r)||(0,m.lq)(r))&&this.params.encoding===n.DDS_ENCODING?this.loadFromDDSData(e,r):((0,m.eP)(r)||(0,m.lq)(r))&&this.params.encoding===n.KTX2_ENCODING?this.loadFromKTX2(e,r):((0,m.eP)(r)||(0,m.lq)(r))&&this.params.encoding===n.BASIS_ENCODING?this.loadFromBasis(e,r):(0,m.lq)(r)?this.loadFromPixelData(e,r):(0,m.eP)(r)?this.loadFromPixelData(e,new Uint8Array(r)):null}},{key:"requiresFrameUpdates",get:function(){return this.data instanceof HTMLVideoElement}},{key:"frameUpdate",value:function(e,t,n){if(!(this.data instanceof HTMLVideoElement)||(0,p.Wi)(this._glTexture))return n;if(this.data.readyState<2||n===this.data.currentTime)return n;if((0,p.pC)(this._powerOfTwoStretchInfo)){var r=this._powerOfTwoStretchInfo,a=r.framebuffer,i=r.vao,o=r.sourceTexture;o.setData(this.data),this.drawStretchedTexture(e,t,a,i,o,this._glTexture)}else{var s=this.data,l=s.width,u=s.height,c=this._glTexture.descriptor,d=c.width,v=c.height;l!==d||u!==v?this._glTexture.updateData(0,0,0,Math.min(l,d),Math.min(u,v),this.data):this._glTexture.setData(this.data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.data.currentTime}},{key:"loadFromDDSData",value:function(e,t){return this._glTexture=function(e,t,n){var r=U(n,t.hasMipmap),a=r.textureData,i=r.internalFormat,o=r.width,s=r.height;return t.samplingMode=a.levels.length>1?9987:9729,t.hasMipmap=a.levels.length>1,t.internalFormat=i,t.width=o,t.height=s,new _.Z(e,t,a)}(e,this.createDescriptor(e),t),this._glTexture}},{key:"loadFromKTX2",value:function(e,t){var n=this;return this.loadAsync((function(){return function(e,t,n){return A.apply(this,arguments)}(e,n.createDescriptor(e),t).then((function(e){return n._glTexture=e,e}))}))}},{key:"loadFromBasis",value:function(e,t){var n=this;return this.loadAsync((function(){return function(e,t,n){return N.apply(this,arguments)}(e,n.createDescriptor(e),t).then((function(e){return n._glTexture=e,e}))}))}},{key:"loadFromPixelData",value:function(e,t){(0,G.hu)(this.params.width>0&&this.params.height>0);var n=this.createDescriptor(e);return n.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,n.width=this.params.width,n.height=this.params.height,this._glTexture=new _.Z(e,n,t),this._glTexture}},{key:"loadFromURL",value:function(e,t,n){var r=this;return this.loadAsync(function(){var i=(0,a.Z)(u.mark((function a(i){var o;return u.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(0,x.t)(n,{signal:i});case 2:return o=a.sent,a.abrupt("return",r.loadFromImage(e,o,t));case 4:case"end":return a.stop()}}),a)})));return function(e){return i.apply(this,arguments)}}())}},{key:"loadFromImageElement",value:function(e,t,n){var r=this;return n.complete?this.loadFromImage(e,n,t):this.loadAsync(function(){var i=(0,a.Z)(u.mark((function a(i){var o;return u.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(0,S.f)(n,n.src,!1,i);case 2:return o=a.sent,a.abrupt("return",r.loadFromImage(e,o,t));case 4:case"end":return a.stop()}}),a)})));return function(e){return i.apply(this,arguments)}}())}},{key:"loadFromVideoElement",value:function(e,t,n){return n.readyState>=2?this.loadFromImage(e,n,t):this.loadFromVideoElementAsync(e,t,n)}},{key:"loadFromVideoElementAsync",value:function(e,t,n){var r=this;return this.loadAsync((function(a){return new Promise((function(i,o){var s=function(){n.removeEventListener("loadeddata",l),n.removeEventListener("error",u),(0,p.hw)(c)},l=function(){n.readyState>=2&&(s(),i(r.loadFromImage(e,n,t)))},u=function(e){s(),o(e||new d.Z("Failed to load video"))};n.addEventListener("loadeddata",l),n.addEventListener("error",u);var c=(0,h.fu)(a,(function(){return u((0,h.zE)())}))}))}))}},{key:"loadFromImage",value:function(e,t,r){var a=n.getDataDimensions(t);this.params.width=a.width,this.params.height=a.height;var i=this.createDescriptor(e);return i.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(e,i)||(0,f.wt)(a.width)&&(0,f.wt)(a.height)?(i.width=a.width,i.height=a.height,this._glTexture=new _.Z(e,i,t),this._glTexture):(this._glTexture=this.makePowerOfTwoTexture(e,t,a,i,r),this._glTexture)}},{key:"loadAsync",value:function(e){var t=this,n=new AbortController;this._loadingController=n;var r=e(n.signal);this._loadingPromise=r;var a=function(){t._loadingController===n&&(t._loadingController=null),t._loadingPromise===r&&(t._loadingPromise=null)};return r.then(a,a),r}},{key:"requiresPowerOfTwo",value:function(e,t){var n=33071,r="number"==typeof t.wrapMode?t.wrapMode===n:t.wrapMode.s===n&&t.wrapMode.t===n;return!(0,B.Z)(e.gl)&&(t.hasMipmap||!r)}},{key:"makePowerOfTwoTexture",value:function(e,t,n,r,a){var i,o=n.width,s=n.height,l=(0,f.Sf)(o),u=(0,f.Sf)(s);switch(r.width=l,r.height=u,this.params.powerOfTwoResizeMode){case 2:r.textureCoordinateScaleFactor=[o/l,s/u],(i=new _.Z(e,r)).updateData(0,0,0,o,s,t);break;case 1:case null:case void 0:i=this.stretchToPowerOfTwo(e,t,r,a());break;default:(0,c.Bg)(this.params.powerOfTwoResizeMode)}return r.hasMipmap&&i.generateMipmap(),i}},{key:"stretchToPowerOfTwo",value:function(e,t,n,r){var a=new _.Z(e,n),i=new q.Z(e,{colorTarget:0,depthStencilTarget:0},a),o=new _.Z(e,{target:3553,pixelFormat:n.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!n.flipped,maxAnisotropy:8,preMultiplyAlpha:n.preMultiplyAlpha},t),s=(0,W.ow)(e),l=e.getBoundFramebufferObject();return this.drawStretchedTexture(e,r,i,s,o,a),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:s,sourceTexture:o,framebuffer:i}:(s.dispose(!0),o.dispose(),i.detachColorTexture(),i.dispose()),e.bindFramebuffer(l),a}},{key:"drawStretchedTexture",value:function(e,t,n,r,a,i){e.bindFramebuffer(n);var o=e.getViewport();e.setViewport(0,0,i.descriptor.width,i.descriptor.height);var s=t.program;e.useProgram(s),s.setUniform4f("color",1,1,1,1),s.bindTexture(a,"tex"),e.bindVAO(r),t.bindPipelineState(e),e.drawArrays(5,0,(0,z._V)(r,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height)}},{key:"unload",value:function(){if((0,p.pC)(this._powerOfTwoStretchInfo)){var e=this._powerOfTwoStretchInfo,t=e.framebuffer,n=e.vao,r=e.sourceTexture;n.dispose(!0),r.dispose(),t.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if((0,p.pC)(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),(0,p.pC)(this._loadingController)){var a=this._loadingController;this._loadingController=null,this._loadingPromise=null,a.abort()}this.events.emit("unloaded")}}],[{key:"getDataDimensions",value:function(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}},{key:"estimateTexMemRequired",value:function(e,t){if((0,p.Wi)(e))return 0;if((0,m.eP)(e)||(0,m.lq)(e))return t.encoding===n.KTX2_ENCODING?function(e,t){if((0,p.Wi)(C))return e.byteLength;var n=new C.KTX2File(new Uint8Array(e)),r=D(n)?I(n.getLevels(),n.getHasAlpha(),n.getWidth(),n.getHeight(),t):0;return n.close(),n.delete(),r}(e,t.mipmap):t.encoding===n.BASIS_ENCODING?function(e,t){if((0,p.Wi)(C))return e.byteLength;var n=new C.BasisFile(new Uint8Array(e)),r=F(n)?I(n.getNumLevels(0),n.getHasAlpha(),n.getImageWidth(0,0),n.getImageHeight(0,0),t):0;return n.close(),n.delete(),r}(e,t.mipmap):e.byteLength;var r=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?n.getDataDimensions(e):t,a=r.width,i=r.height;return(t.mipmap?4/3:1)*a*i*(t.components||4)||0}}]),n}(Z.c);X.DDS_ENCODING="image/vnd-ms.dds",X.KTX2_ENCODING="image/ktx2",X.BASIS_ENCODING="image/x.basis"}}]);
//# sourceMappingURL=6888.b3441ddc.chunk.js.map